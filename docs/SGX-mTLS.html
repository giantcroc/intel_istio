<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Istio mTLS Private Key Protection with SGX &mdash; Intel managed distribution of Istio</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Istio Gateway Private Key Protection with SGX" href="SGX-gateway.html" />
    <link rel="prev" title="Istio acceleration with Intel® AVX512 crypto instructions" href="CRYPTOMB.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Intel managed distribution of Istio
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Intel managed distribution of Istio</a></li>
<li class="toctree-l1"><a class="reference internal" href="QAT.html">Istio crypto and compression acceleration with QAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="CRYPTOMB.html">Istio acceleration with Intel® AVX512 crypto instructions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Istio mTLS Private Key Protection with SGX</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-sample-application">Deploy sample application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cleaning-up">Cleaning Up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SGX-gateway.html">Istio Gateway Private Key Protection with SGX</a></li>
<li class="toctree-l1"><a class="reference internal" href="Grafana-Dashboard.html">Grafana Dashboard</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel managed distribution of Istio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Istio mTLS Private Key Protection with SGX</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/SGX-mTLS.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="istio-mtls-private-key-protection-with-sgx">
<h1>Istio mTLS Private Key Protection with SGX<a class="headerlink" href="#istio-mtls-private-key-protection-with-sgx" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Protecting Istio mTLS private keys with Intel® SGX enhances the service mesh security. The private keys are stored and used inside the SGX enclave(s) and will never stored in clear anywhere in the system. Authorized applications use the private key in the enclave by key-handle provided by SGX.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<p>Prerequisites for using Istio mTLS private key protection with SGX:</p>
<ul class="simple">
<li><p>Kubernetes cluster with one or more nodes with Intel® <a class="reference external" href="https://software.intel.com/content/www/us/en/develop/topics/software-guard-extensions.html">SGX</a> supported hardware</p></li>
<li><p><a class="reference external" href="https://github.com/intel/intel-device-plugins-for-kubernetes/blob/main/cmd/sgx_plugin/README.md">Intel® SGX device plugin</a> for Kubernetes</p></li>
<li><p><a class="reference external" href="https://github.com/intel/linux-sgx#install-the-intelr-sgx-psw">Intel® SGX AESM daemon</a></p></li>
<li><p>Linux kernel version 5.11 or later on the host (in tree SGX driver)</p></li>
<li><p><a class="reference external" href="https://github.com/intel/trusted-certificate-issuer">trusted-certificate-issuer</a></p></li>
</ul>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading"></a></h2>
<p>This section covers how to install Istio mTLS private key protection with SGX</p>
<ol class="simple">
<li><p>Create sgx-signer (Refer to https://github.com/intel/trusted-certificate-issuer/blob/main/docs/istio-custom-ca-with-csr.md)</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">CA_SIGNER_NAME</span><span class="o">=</span>sgx-signer
$<span class="w"> </span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | kubectl create -f -</span>
<span class="s">apiVersion: tcs.intel.com/v1alpha1</span>
<span class="s">kind: TCSClusterIssuer</span>
<span class="s">metadata:</span>
<span class="s">    name: $CA_SIGNER_NAME</span>
<span class="s">spec:</span>
<span class="s">    secretName: ${CA_SIGNER_NAME}-secret</span>
<span class="s">    # If using quoteattestaion, set selfSign as false</span>
<span class="s">    # selfSign: false</span>
<span class="s">EOF</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get CA Cert and replace it in ./intel/yaml/intel-istio-sgx-mTLS.yaml</span>
$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>-n<span class="w"> </span>tcs-issuer<span class="w"> </span><span class="si">${</span><span class="nv">CA_SIGNER_NAME</span><span class="si">}</span>-secret<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.tls\.crt}&#39;</span><span class="w"> </span><span class="p">|</span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s;\(.*\);        \1;g&#39;</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Build sds-server images</p></li>
</ol>
<p>Build from source code:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting the source code</span>
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/istio-ecosystem/hsm-sds-server.git
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build image</span>
$<span class="w"> </span>make<span class="w"> </span>docker
</pre></div>
</div>
<blockquote>
<div><p>NOTE: If you are using containerd as the container runtime, run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">ctr</span></code> to build the image instead.</p>
</div></blockquote>
<ol class="simple">
<li><p>Install Istio</p></li>
</ol>
<blockquote>
<div><p>NOTE: for the below command you need to use the <code class="docutils literal notranslate"><span class="pre">istioctl</span></code> for the <code class="docutils literal notranslate"><span class="pre">docker.io/intel/istioctl:1.16.1-intel.0</span></code> since only that contains Istio manifest enhancements for SGX mTLS.</p>
</div></blockquote>
<p>You can also customize the <code class="docutils literal notranslate"><span class="pre">intel-istio-sgx-mTLS.yaml</span></code> according to your needs. If you want do the quote verification, you can set the <code class="docutils literal notranslate"><span class="pre">NEED_QUOTE</span></code> env as <code class="docutils literal notranslate"><span class="pre">true</span></code>. And if you are using the TCS v1alpha1 api, you should set the <code class="docutils literal notranslate"><span class="pre">RANDOM_NONCE</span></code> as <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>istioctl<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>./intel/yaml/intel-istio-sgx-mTLS.yaml<span class="w"> </span>-y
</pre></div>
</div>
<ol class="simple">
<li><p>Verifiy the pods are running</p></li>
</ol>
<p>By deault, <code class="docutils literal notranslate"><span class="pre">Istio</span></code> will be installed in the <code class="docutils literal notranslate"><span class="pre">istio-system</span></code> namespce</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ensure that the pod is running state</span>
$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>-n<span class="w"> </span>istio-system
NAME<span class="w">                                    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
istio-ingressgateway-6cd77bf4bf-t4cwj<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>70m
istiod-6cf88b78dc-dthpw<span class="w">                 </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>70m
</pre></div>
</div>
</section>
<section id="deploy-sample-application">
<h2>Deploy sample application<a class="headerlink" href="#deploy-sample-application" title="Permalink to this heading"></a></h2>
<ol class="simple">
<li><p>Create sleep and httpbin deployment:</p></li>
</ol>
<blockquote>
<div><p>NOTE: If you want use the sds-custom injection template, you need to set the annotations <code class="docutils literal notranslate"><span class="pre">inject.istio.io/templates</span></code> for both <code class="docutils literal notranslate"><span class="pre">sidecar</span></code> and <code class="docutils literal notranslate"><span class="pre">sgx</span></code>. And the ClusterRole is also required.</p>
</div></blockquote>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>&lt;<span class="o">(</span>istioctl<span class="w"> </span>kube-inject<span class="w"> </span>-f<span class="w"> </span>./intel/yaml/sleep-sgx-mTLS.yaml<span class="w"> </span><span class="o">)</span>
$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>&lt;<span class="o">(</span>istioctl<span class="w"> </span>kube-inject<span class="w"> </span>-f<span class="w"> </span>./intel/yaml/httpbin-sgx-mTLS.yaml<span class="w"> </span><span class="o">)</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Successful deployment looks like this:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>po
NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
httpbin-5f6bf4d4d9-5jxj8<span class="w">   </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>30s
sleep-57bc8d74fc-2lw4n<span class="w">     </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7s
</pre></div>
</div>
<ol class="simple">
<li><p>Test pod resources:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>sleep<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">={</span>.items..metadata.name<span class="o">}</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>-c<span class="w"> </span>sleep<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>http://httpbin.default:8000/headers<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>X-Forwarded-Client-Cert
<span class="w">    </span><span class="s2">&quot;X-Forwarded-Client-Cert&quot;</span>:<span class="w"> </span><span class="s2">&quot;By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=2875ce095572f8a12b6080213f7789bfb699099b83e8ea2889a2d7b3eb9523e6;Subject=\&quot;CN=SGX based workload,O=Intel(R) Corporation\&quot;;URI=spiffe://cluster.local/ns/default/sa/sleep&quot;</span>
</pre></div>
</div>
<p>The above <code class="docutils literal notranslate"><span class="pre">httpbin</span></code> and <code class="docutils literal notranslate"><span class="pre">sleep</span></code> applications have enabled SGX and store the private keys inside SGX enclave, completed the TLS handshake and established a connection with each other and communicating normally.</p>
</section>
<section id="cleaning-up">
<h2>Cleaning Up<a class="headerlink" href="#cleaning-up" title="Permalink to this heading"></a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># uninstall istio</span>
$<span class="w"> </span>istioctl<span class="w"> </span>x<span class="w"> </span>uninstall<span class="w"> </span>--purge<span class="w"> </span>-y
<span class="c1"># delete workloads</span>
$<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>./intel/yaml/sleep-sgx-mTLS.yaml
$<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>./intel/yaml/httpbin-sgx-mTLS.yaml
</pre></div>
</div>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://github.com/intel/trusted-certificate-issuer">Trusted Certificate Issuer</a></p>
<p><a class="reference external" href="https://github.com/intel/trusted-attestation-controller">Trusted Attestation Controller</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CRYPTOMB.html" class="btn btn-neutral float-left" title="Istio acceleration with Intel® AVX512 crypto instructions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="SGX-gateway.html" class="btn btn-neutral float-right" title="Istio Gateway Private Key Protection with SGX" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, various.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>